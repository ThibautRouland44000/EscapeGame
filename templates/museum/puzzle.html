{% extends "game/base.html" %}
{% load static %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>üñºÔ∏è √âpreuve Mus√©e ‚Äî Associez ≈ìuvres ‚Üî emojis</div>
  <div>‚≠ê Score: {{ team.score }}</div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">
            {% if role == "A" %}
            Tu vois les <strong>6 ≈ìuvres</strong>. D√©cris-les √† ton bin√¥me.
            {% else %}
            Tu vois <strong>6 listes d‚Äôemojis</strong>. Associe-les aux ≈ìuvres d‚ÄôAlex.
            {% endif %}
        </h2>

        {% if role == "A" %}
            <a href="{% url 'lobby' team.uuid %}" class="btn btn-outline-secondary btn-sm">
            ‚Üê Retour au lobby
            </a>
        {% endif %}
      </div>

      <div class="card-body">
        {% if feedback %}<div class="alert alert-warning">{{ feedback }}</div>{% endif %}

        {% if role == "A" %}
          <!-- Images anonymis√©es : ≈íuvre 1..6 -->
          <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for art in artworks %}
              <div class="col">
                <div class="border rounded p-2 h-100">
                  <div class="small text-muted mb-1">{{ art.label }}</div>
                  <img src="{% static art.img %}" alt="{{ art.label }}" class="img-fluid mb-2" onerror="this.style.display='none'">
                  <div class="text-muted small">D√©cris l‚Äôimage (couleurs, √©l√©ments, style) √† ton bin√¥me.</div>
                </div>
              </div>
            {% endfor %}
          </div>

        {% else %}
          <!-- Listes d‚Äôemojis m√©lang√©es + selects ‚Äú≈íuvre 1..6‚Äù -->
          <form method="post" class="row g-3">
            {% csrf_token %}
            {% for item in emoji_list %}
              <div class="col-12">
                <label class="form-label">
                  <span class="badge text-bg-secondary me-2">{{ item.key }}</span>
                  {% for e in item.emojis %}<span style="font-size:1.2rem">{{ e }}</span>{% endfor %}
                </label>
                <select class="form-select" name="map_{{ item.key }}" required>
                  <option value="" selected disabled>Choisir l‚Äô≈ìuvre‚Ä¶</option>
                  {% for art in artworks %}
                    <option value="{{ art.slug }}">{{ art.label }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endfor %}
            <div class="col-12 d-grid">
              <button class="btn btn-success">Valider les associations</button>
            </div>
          </form>
          <p class="text-muted mt-2 mb-0 small">
            Astuce : demande ‚ÄúLe paquet d‚Äôemojis üåä‚õµüóª correspond √† quelle image (≈íuvre n¬∞) ?‚Äù
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-body">
        {% include "../comms/_chat.html" with TEAM=team.uuid %}
      </div>
    </div>
  </div>
</div>

{% if success %}
<!-- Overlay plein √©cran de succ√®s -->
<div id="successOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
     style="background:rgba(0,0,0,.5); z-index:1050;">
  <div class="bg-white rounded-4 p-4 text-center shadow-lg" style="max-width:420px; width:92%;">
    <!-- Check anim√© (SVG) -->
    <svg viewBox="0 0 72 72" width="120" height="120" class="mb-3">
      <circle cx="36" cy="36" r="34" fill="none" stroke="#28a745" stroke-width="4" opacity=".15"/>
      <circle cx="36" cy="36" r="34" fill="none" stroke="#28a745" stroke-width="4"
              stroke-dasharray="214" stroke-dashoffset="214">
        <animate attributeName="stroke-dashoffset" from="214" to="0" dur="0.6s" fill="freeze"/>
      </circle>
      <polyline points="20,37 31,48 52,26" fill="none" stroke="#28a745" stroke-width="4"
                stroke-linecap="round" stroke-linejoin="round"
                stroke-dasharray="50" stroke-dashoffset="50">
        <animate attributeName="stroke-dashoffset" from="50" to="0" dur="0.5s" begin="0.4s" fill="freeze"/>
      </polyline>
    </svg>

    <h3 class="h5 mb-1">Bravo ! √âpreuve du Mus√©e r√©ussie ‚úÖ</h3>
    <p class="text-muted mb-3">Lettre <strong>¬´ O ¬ª</strong> ajout√©e √† votre mot-cl√©.</p>

    <a href="{{ next_url }}" class="btn btn-success">Continuer</a>
    <div class="small text-muted mt-2">Redirection automatique‚Ä¶</div>
  </div>
</div>

<script>
setTimeout(function(){ window.location.href = "{{ next_url }}"; }, 1800);
(function(){
  const overlay = document.getElementById("successOverlay");
  for (let i=0; i<40; i++){
    const s = document.createElement("div");
    s.style.position="fixed";
    s.style.top="-10px";
    s.style.left=(Math.random()*100)+"%";
    s.style.width="6px"; s.style.height="10px";
    s.style.background="hsl("+Math.floor(Math.random()*360)+" 90% 60%)";
    s.style.opacity="0.9";
    s.style.transform=`rotate(${Math.random()*360}deg)`;
    s.style.borderRadius="1px";
    s.style.zIndex="2000";
    s.style.transition="transform 1.2s linear, top 1.2s linear, opacity .2s ease .9s";
    overlay.appendChild(s);
    requestAnimationFrame(()=>{ s.style.top="110%"; s.style.transform+=" translateY(100vh)"; s.style.opacity="0"; });
  }
})();
</script>
{% endif %}

{% endblock %}
