{% extends "game/base.html" %}
{% load static %}
{% block content %}

<style>
.room-wrap{position:relative}
.room-img{width:100%; border-radius:.5rem}
.clickable{cursor:pointer}
.badge-floating{position:absolute; padding:.35rem .5rem; font-size:.75rem; border-radius:.5rem}
#curtainsHit{position:absolute; left:6%; top:10%; width:55%; height:55%} /* zone rideaux/window */

#windowOverlay{position:absolute; left:22%; top:16%; width:22%; height:34%;
  background:linear-gradient(#8fd3fe,#dff3ff); border-radius:.25rem; display:none;
}
.tag{user-select:none}

.controls .form-range{width:100%}
.progress-sm{height:.5rem}

.zoom-label{position:absolute; right:10%; top:50%; transform:translateY(-50%); font-size:1.7rem}
.tooltip-mini{position:absolute; right:6%; bottom:14%; background:#0006; color:#fff; padding:.25rem .5rem;
  border-radius:.25rem; font-size:.8rem; display:none}
</style>
<style>
/* ==== Livre anim√© (manuel) ==== */
.book-wrap{perspective:1200px; margin:0 auto 1rem;}
.book{
  position:relative; width:100%; max-width:740px; height:360px; margin:0 auto;
  border-radius:14px; background:#f8f9fa; box-shadow:0 10px 25px rgba(0,0,0,.08) inset;
}
.book .pages{
  position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; gap:0;
  border-radius:14px; overflow:hidden; background:linear-gradient(90deg,#fff 49.5%,#e9ecef 50%);
}
.book .page{
  padding:18px 20px 16px; overflow:auto;
}
.book .page h4{ font-size:1rem; margin:.25rem 0 .5rem; }
.book .page ul{ margin:0 0 .5rem 1rem; }
.book .page li{ font-size:.9rem; line-height:1.25rem; margin:.25rem 0; }
.book .spine{
  position:absolute; left:50%; top:0; width:10px; height:100%;
  transform:translateX(-50%); background:linear-gradient(#d0d4da,#c7ccd3);
  box-shadow:inset 0 0 6px #adb5bd;
}
.book .bookmark{
  position:absolute; right:16px; top:0; width:10px; height:46px; background:#ffbf69; border-radius:0 0 6px 6px;
}

/* Couverture anim√©e */
.book .cover{
  position:absolute; left:0; top:0; width:50%; height:100%;
  transform-origin:left center; transform:rotateY(0deg);
  transition:transform .8s ease, box-shadow .8s ease;
  border-radius:14px 0 0 14px;
  background:linear-gradient(135deg,#3b5bdb,#74c0fc);
  box-shadow:3px 0 10px rgba(0,0,0,.25);
  color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer;
}
.book .cover .title{ text-align:center; padding:0 22px; }
.book .cover .title .big{ font-size:1.15rem; font-weight:700; letter-spacing:.4px; display:block; }
.book .cover .title .sub{ font-size:.9rem; opacity:.9; }
.book .cover .hint{ position:absolute; bottom:12px; font-size:.8rem; opacity:.9; }

.book.open .cover{
  transform:rotateY(-165deg);
  box-shadow:-6px 0 14px rgba(0,0,0,.15);
}
/* Pages cach√©es tant que le livre n'est pas ouvert */
.book .pages{
  opacity: 0;
  pointer-events: none;
  transition: opacity .35s ease;
}
.book.open .pages{
  opacity: 1;
  pointer-events: auto;
}

/* Accessibilit√© & petits √©crans */
@media (max-width: 768px){ .book{ height:420px; } .book .page{ padding:14px; } }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>üõèÔ∏è √âpreuve ‚Äî Chambre d‚Äôh√¥tel √©co</div>
  <div>‚≠ê Score: {{ team.score }}</div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">
          {% if role == "A" %}Observe la chambre et r√®gle <strong>clim / douche / lumi√®re</strong>.
          {% else %}Lis le <strong>manuel</strong> et guide ton bin√¥me via le chat.
          {% endif %}
        </h2>
        <a href="{% url 'lobby' team.uuid %}" class="btn btn-outline-secondary btn-sm">‚Üê Lobby</a>
      </div>

      <div class="card-body">
        {% if feedback %}<div class="alert alert-warning mb-3">{{ feedback }}</div>{% endif %}

        {% if role == "A" %}
          <!-- IMAGE INTERACTIVE -->
          <div class="room-wrap mb-3">
            <img src="{% static 'hotel/roomclosed.png' %}" class="room-img" alt="Chambre d'h√¥tel">

            <!-- saison visible quand on √©carte les rideaux -->
            <div id="windowOverlay"></div>

            <!-- zones cliquables -->
            <div id="curtainsHit" class="clickable" title="Cliquer pour √©carter les rideaux"></div>
            <!-- miroir -->
            <div id="mirrorHit" class="clickable" title="Miroir"
                 style="position:absolute; right:9.5%; top:24%; width:18%; height:30%;"></div>
            <!-- label douche (emoji) -->
            <div id="labelBadge" class="badge-floating bg-light border zoom-label clickable" title="Voir le label">
              {% if scene.label == 'feuille' %}üçÉ{% elif scene.label == 'bonhomme' %}üßç{% else %}‚≠êÔ∏è{% endif %}
            </div>
            <!-- robinet -->
            <div id="tapHit" class="clickable" title="Robinet"
                 style="position:absolute; right:7.5%; bottom:28%; width:9%; height:10%;"></div>
            <div id="tapTip" class="tooltip-mini">C‚Äôest juste un robinet.</div>
          </div>

          <!-- R√âGLAGES -->
          <form method="post" class="controls">
            {% csrf_token %}
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Climatisation</label>
                <div class="btn-group w-100" role="group" aria-label="AC">
                  <input type="radio" class="btn-check" name="ac" id="ac_off" value="off" checked>
                  <label class="btn btn-outline-danger" for="ac_off">OFF</label>
                  <input type="radio" class="btn-check" name="ac" id="ac_on" value="on">
                  <label class="btn btn-outline-success" for="ac_on">ON (24¬∞)</label>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Douche (minutes)
                  <span id="showerVal" class="badge text-bg-secondary ms-1">10</span>
                </label>
                <input type="range" min="1" max="15" value="10" id="shower"
                       class="form-range" name="shower">
                <div class="progress progress-sm">
                  <div id="showerBar" class="progress-bar" style="width:66%"></div>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Lumi√®re</label>
                <select class="form-select" name="light" id="lightSel">
                  <option value="basse">Basse (3+ ampoules)</option>
                  <option value="moyenne" selected>Moyenne (2)</option>
                  <option value="forte">Forte (1)</option>
                </select>
                <div class="small text-muted mt-1">Au plafond : {{ scene.bulbs }} ampoules ‚Üí basse conso</div>
              </div>

              <div class="col-12 d-grid">
                <button class="btn btn-success">Valider la chambre</button>
              </div>
            </div>
          </form>

        {% else %}
          <!-- MANUEL (r√¥le B) ‚Äî Livre qui s'ouvre -->
            <div class="book-wrap">
            <div id="manualBook" class="book" role="region" aria-label="Manuel d'√©conomie d'√©nergie">
                <!-- Couverture -->
                <div class="cover" id="manualCover" tabindex="0" aria-expanded="false" aria-controls="manualPages">
                <div class="title">
                    <span class="big">Manuel d‚Äô√©conomie d‚Äô√©nergie</span>
                    <span class="sub">Chambre d‚Äôh√¥tel ‚Ä¢ Guide rapide</span>
                </div>
                <div class="hint">Cliquer / Entr√©e pour ouvrir</div>
                </div>

                <!-- Int√©rieur du livre -->
                <div class="pages" id="manualPages">
                <div class="spine"></div>
                <div class="bookmark"></div>

                <!-- Page gauche -->
                <div class="page">
                    <h4>üå¶Ô∏è Saisons ‚Üí r√©glage</h4>
                    <ul>
                    <li>√ât√© <em>(ciel bleu + grand soleil)</em> ‚Üí <strong>clim √† 24¬∞</strong></li>
                    <li>Automne <em>(ciel gris + feuilles marron)</em> ‚Üí <strong>chauffage √† 21¬∞</strong></li>
                    <li>Hiver <em>(ciel gris/blanc + flocons)</em> ‚Üí <strong>chauffage √† 19¬∞</strong></li>
                    <li>Printemps <em>(ciel bleu + feuilles vertes)</em> ‚Üí <strong>√©teindre clim/chauffage</strong></li>
                    </ul>

                    <h4 class="mt-3">üí° Ampoules au plafond</h4>
                    <ul>
                    <li>1 = consommation <strong>importante</strong></li>
                    <li>2 = consommation <strong>moyenne</strong></li>
                    <li>3 et + = <strong>basse</strong> consommation</li>
                    </ul>
                </div>

                <!-- Page droite -->
                <div class="page">
                    <h4>üöø Label douche ‚Üí dur√©e</h4>
                    <ul>
                    <li>üçÉ feuille verte = <strong>&lt; 5 minutes</strong></li>
                    <li>üßç bonhomme bleu = <strong>5 √† 10 minutes</strong></li>
                    <li>‚≠êÔ∏è √©toile jaune = <strong>10 minutes et +</strong></li>
                    </ul>

                    <h4 class="mt-3">ü™û Type de miroir</h4>
                    <div class="small mb-2">rond / rectangulaire / triangulaire</div>

                    <h4>üö∞ Type de robinet</h4>
                    <div class="small">rouge / bleu / jaune</div>

                    <hr>
                    <p class="text-muted small mb-0">
                    <strong>Astuce :</strong> demande √† ton bin√¥me d‚Äôouvrir les rideaux et de d√©crire le ciel,
                    puis ajuste clim / douche / lumi√®re en cons√©quence.
                    </p>
                </div>
                </div>
            </div>
            </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="col-lg-4">
    <div class="card shadow-sm"><div class="card-body">
      {% include "comms/_chat.html" with TEAM=team.uuid %}
    </div></div>
  </div>
</div>

{% if success %}
<!-- Overlay succ√®s -->
<div id="successOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
     style="background:rgba(0,0,0,.5); z-index:1050;">
  <div class="bg-white rounded-4 p-4 text-center shadow-lg" style="max-width:420px; width:92%;">
    <svg viewBox="0 0 72 72" width="120" height="120" class="mb-3">
      <circle cx="36" cy="36" r="34" fill="none" stroke="#28a745" stroke-width="4" opacity=".15"/>
      <circle cx="36" cy="36" r="34" fill="none" stroke="#28a745" stroke-width="4" stroke-dasharray="214" stroke-dashoffset="214">
        <animate attributeName="stroke-dashoffset" from="214" to="0" dur="0.6s" fill="freeze"/>
      </circle>
      <polyline points="20,37 31,48 52,26" fill="none" stroke="#28a745" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="50" stroke-dashoffset="50">
        <animate attributeName="stroke-dashoffset" from="50" to="0" dur="0.5s" begin="0.4s" fill="freeze"/>
      </polyline>
    </svg>
    <h3 class="h5 mb-1">Bravo ! √âpreuve de la Chambre r√©ussie ‚úÖ</h3>
    <p class="text-muted mb-3">Vous venez de gagner un nouveau code.</p>
    <a href="{{ next_url }}" class="btn btn-success">Continuer</a>
    <div class="small text-muted mt-2">Redirection automatique‚Ä¶</div>
  </div>
</div>
<script>setTimeout(()=>{location.href="{{ next_url }}";},1800)</script>
{% endif %}

{% if role == "A" %}
<script>
// Rideaux ‚Üí afficher la saison
const windowOverlay = document.getElementById('windowOverlay');
const curtainsHit = document.getElementById('curtainsHit');
const mirrorHit = document.getElementById('mirrorHit');
const labelBadge = document.getElementById('labelBadge');
const tapHit = document.getElementById('tapHit');
const tapTip = document.getElementById('tapTip');

let curtainsOpen = false;
curtainsHit.addEventListener('click', ()=>{
  curtainsOpen = !curtainsOpen;
  if(curtainsOpen){
    // ‚Äúouvrir‚Äù : montrer la saison (printemps)
    windowOverlay.style.display = 'block';
    windowOverlay.style.background = 'linear-gradient(#86e1ff,#dff8ff)';
    // ajoute quelques ‚Äúfeuilles‚Äù (printemps)
    windowOverlay.innerHTML = '';
    for(let i=0;i<6;i++){
      const s=document.createElement('div');
      s.textContent='üçÉ'; s.style.position='absolute';
      s.style.left=(10+Math.random()*80)+'%';
      s.style.top=(-10+Math.random()*20)+'%';
      s.style.transition='top 1.4s linear'; windowOverlay.appendChild(s);
      requestAnimationFrame(()=>{s.style.top='90%';});
    }
  }else{
    windowOverlay.style.display = 'none';
    windowOverlay.innerHTML = '';
  }
});

// Miroir ‚Üí compliment + jauge
mirrorHit.addEventListener('click', ()=>{
  const bar = document.getElementById('selfBar');
  if(!bar){
    const wrap = document.createElement('div');
    wrap.className = 'mt-2';
    wrap.innerHTML = `
      <div class="small text-muted">Confiance en soi</div>
      <div class="progress progress-sm"><div id="selfBar" class="progress-bar" style="width:25%"></div></div>
      <div class="small">Vous vous trouvez tr√®s beau aujourd‚Äôhui ‚ú®</div>`;
    document.querySelector('.controls')?.prepend(wrap);
  }else{
    const cur = parseInt(bar.style.width)||25;
    bar.style.width = Math.min(100, cur+25)+'%';
  }
});

// Label ‚Üí zoom
labelBadge.addEventListener('click', ()=>{
  labelBadge.style.transform = 'scale(1.6)';
  setTimeout(()=>{labelBadge.style.transform='scale(1)';}, 500);
});

// Robinet ‚Üí tooltip
tapHit.addEventListener('click', ()=>{
  tapTip.style.display='block';
  setTimeout(()=>{tapTip.style.display='none';}, 1200);
});

// UI live
const shower = document.getElementById('shower');
const showerVal = document.getElementById('showerVal');
const showerBar = document.getElementById('showerBar');
function upd(){ showerVal.textContent = shower.value; showerBar.style.width = (shower.value/15*100)+'%'; }
shower.addEventListener('input', upd); upd();

// Adapter la lumi√®re par d√©faut en fonction des ampoules (3+ ‚Üí basse)
document.getElementById('lightSel').value = 'basse';
</script>
{% endif %}

{% if role == "B" %}
<script>
(() => {
  const book   = document.getElementById('manualBook');
  const cover  = document.getElementById('manualCover');

  function toggleBook(){
    const open = book.classList.toggle('open');
    cover.setAttribute('aria-expanded', open ? 'true' : 'false');
    const hint = cover.querySelector('.hint');
    if(hint){ hint.textContent = open ? "Cliquer pour fermer" : "Cliquer / Entr√©e pour ouvrir"; }
  }

  cover.addEventListener('click', toggleBook);
  cover.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleBook(); }
  });
})();
</script>
{% endif %}

{% endblock %}


